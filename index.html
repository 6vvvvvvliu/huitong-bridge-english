<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æƒ é€šæ¡¥è‹±è¯­æ˜Ÿé™…æ¢é™©</title>
    <!-- å¼•å…¥ React å’Œ Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥å›¾æ ‡åº“ -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* è‡ªå®šä¹‰åŠ¨ç”» */
        @keyframes sound-wave {
            0%, 100% { height: 4px; }
            50% { height: 16px; }
        }
        .animate-sound-wave {
            animation: sound-wave 0.5s infinite ease-in-out;
        }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.4s ease-out forwards;
        }
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        body {
            background-color: #0f172a; /* slate-950 */
            color: white;
            overscroll-behavior: none; /* é˜²æ­¢æ‰‹æœºä¸‹æ‹‰åˆ·æ–°å¹²æ‰° */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, createContext, useContext, Component } = React;

        /* ==========================================
           1. é”™è¯¯è¾¹ç•Œ (Error Boundary) - é˜²æ­¢ç™½å±å´©æºƒ
           ========================================== */
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("React æ•è·åˆ°é”™è¯¯:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-slate-900 flex items-center justify-center p-6 text-center">
                            <div className="bg-slate-800 p-8 rounded-2xl border border-red-500/50 max-w-md w-full">
                                <AlertCircle className="w-12 h-12 text-red-400 mx-auto mb-4" />
                                <h2 className="text-xl font-bold text-white mb-2">å“å‘€ï¼Œé¡µé¢é‡åˆ°äº†ä¸€ç‚¹å°éº»çƒ¦</h2>
                                <p className="text-slate-400 mb-6 text-sm">{this.state.error?.message || "æœªçŸ¥é”™è¯¯"}</p>
                                <button onClick={() => window.location.reload()} className="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded-full text-white font-bold flex items-center justify-center gap-2 mx-auto w-full transition-colors">
                                    <RefreshCw className="w-4 h-4" /> é‡æ–°åŠ è½½åº”ç”¨
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        /* ==========================================
           2. ä¿®å¤æ ¸å¿ƒ BUGï¼šå®‰å…¨çš„ Icon ç»„ä»¶è¾¹ç•Œ
           ========================================== */
        const Icon = ({ name, className, ...props }) => {
            const iconRef = useRef(null);
            
            useEffect(() => {
                if (iconRef.current && window.lucide) {
                    // ä½¿ç”¨éš”ç¦»å®¹å™¨ï¼ŒReact åªè¿½è¸ªå¤–å±‚çš„ spanï¼Œå†…éƒ¨çš„ i æ ‡ç­¾éšæ„è¢« Lucide æ›¿æ¢ä¸º svgï¼Œå½»åº•æœç» removeChild æŠ¥é”™
                    iconRef.current.innerHTML = `<i data-lucide="${name}" class="${className || ''}"></i>`;
                    window.lucide.createIcons({ root: iconRef.current });
                }
            }, [name, className]); // å½“å›¾æ ‡åæˆ–ç±»åå˜åŒ–æ—¶é‡æ–°æ¸²æŸ“å†…éƒ¨

            return <span ref={iconRef} {...props} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        const Rocket = (p) => <Icon name="rocket" {...p}/>;
        const Star = (p) => <Icon name="star" {...p}/>;
        const ArrowRight = (p) => <Icon name="arrow-right" {...p}/>;
        const Check = (p) => <Icon name="check" {...p}/>;
        const RefreshCw = (p) => <Icon name="refresh-cw" {...p}/>;
        const Sparkles = (p) => <Icon name="sparkles" {...p}/>;
        const Globe = (p) => <Icon name="globe" {...p}/>;
        const Shield = (p) => <Icon name="shield" {...p}/>;
        const Hammer = (p) => <Icon name="hammer" {...p}/>;
        const Smile = (p) => <Icon name="smile" {...p}/>;
        const Clapperboard = (p) => <Icon name="clapperboard" {...p}/>;
        const Dna = (p) => <Icon name="dna" {...p}/>;
        const Volume2 = (p) => <Icon name="volume-2" {...p}/>;
        const Mic = (p) => <Icon name="mic" {...p}/>;
        const BookOpen = (p) => <Icon name="book-open" {...p}/>;
        const Play = (p) => <Icon name="play" {...p}/>;
        const AlertCircle = (p) => <Icon name="alert-circle" {...p}/>;
        const Book = (p) => <Icon name="book" {...p}/>;
        const Layout = (p) => <Icon name="layout" {...p}/>;
        const PenTool = (p) => <Icon name="pen-tool" {...p}/>;
        const Feather = (p) => <Icon name="feather" {...p}/>;

        /* ==========================================
           3. æ•°æ®ä¸è¯å…¸åº“
           ========================================== */
        const FULL_ARTICLE = [
            "Huitong Bridge is located on the Nu River in Baoshan, Yunnan.",
            "It was a vital passage on the Burma Road and an important military station during the War of Resistance against Japanese Aggression.",
            "Originally an iron-chain suspension bridge, it was later rebuilt as a steel-cable suspension bridge with donations from overseas Chinese.",
            "In 1942, to stop the Japanese advance, the defending troops reluctantly blew up the bridge, making it a crucial turning point in the Western Yunnan campaign."
        ];

        const VOCAB_DICTIONARY = {
            "reluctantly": { cn: "ä¸æƒ…æ„¿åœ°", ph: "rÉªËˆlÊŒktÉ™ntli", def: "å¿ƒé‡Œä¸æƒ³åšï¼Œä½†ä¸å¾—ä¸åšã€‚" },
            "aggression": { cn: "ä¾µç•¥", ph: "É™ËˆÉ¡reÊƒn", def: "åƒåäººä¸€æ ·å»æ”»å‡»åˆ«äººã€‚" },
            "resistance": { cn: "æŠµæŠ—", ph: "rÉªËˆzÉªstÉ™ns", def: "è¢«äººæ¬ºè´Ÿæ—¶åæŠ—ã€‚" },
            "military": { cn: "å†›äº‹çš„", ph: "ËˆmÉªlÉ™teri", def: "å’Œå†›é˜Ÿã€æ‰“ä»—æœ‰å…³çš„ã€‚" },
            "troops": { cn: "éƒ¨é˜Ÿ", ph: "truËps", def: "ä¸€å¤§ç¾¤å£«å…µã€‚" },
            "advance": { cn: "å‰è¿›", ph: "É™dËˆvÃ¦ns", def: "å‘å‰ç§»åŠ¨ã€‚" },
            "campaign": { cn: "æˆ˜å½¹", ph: "kÃ¦mËˆpeÉªn", def: "ä¸€ç³»åˆ—æˆ˜æ–—ã€‚" },
            "defending": { cn: "é˜²å®ˆ", ph: "dÉªËˆfendÉªÅ‹", def: "ä¿æŠ¤è‡ªå·±ã€‚" },
            "vital": { cn: "è‡³å…³é‡è¦", ph: "ËˆvaÉªtl", def: "åƒç»´ä»–å‘½ä¸€æ ·é‡è¦ã€‚" },
            "crucial": { cn: "å…³é”®çš„", ph: "ËˆkruËÊƒl", def: "å†³å®šæˆè´¥çš„ã€‚" },
            "donations": { cn: "ææ¬¾", ph: "doÊŠËˆneÉªÊƒnz", def: "å¸®åŠ©åˆ«äººçš„é’±ã€‚" },
            "overseas": { cn: "æµ·å¤–çš„", ph: "ËŒoÊŠvÉ™rËˆsiËz", def: "å¤§æµ·é‚£è¾¹çš„ã€‚" },
            "turning point": { cn: "è½¬æŠ˜ç‚¹", ph: "pÉ”Éªnt", def: "äº‹æƒ…å‘ç”Ÿå˜åŒ–ã€‚" },
            "suspension": { cn: "æ‚¬ç´¢", ph: "sÉ™ËˆspenÊƒn", def: "åŠåœ¨ç©ºä¸­çš„ã€‚" },
            "rebuilt": { cn: "é‡å»º", ph: "ËŒriËËˆbÉªlt", def: "é‡æ–°å»ºç«‹ã€‚" },
            "located": { cn: "ä½äº", ph: "loÊŠËˆkeÉªtÉªd", def: "åè½åœ¨ã€‚" },
            "passage": { cn: "é€šé“", ph: "ËˆpÃ¦sÉªdÊ’", def: "å¯ä»¥é€šè¿‡çš„è·¯ã€‚" },
            "iron-chain": { cn: "é“é“¾", ph: "tÊƒeÉªn", def: "é“åšçš„é“¾å­ã€‚" },
            "steel-cable": { cn: "é’¢ç¼†", ph: "keÉªbl", def: "é’¢åšçš„ç»³å­ã€‚" },
            "huitong": { cn: "æƒ é€š", ph: "Name", def: "æ¡¥åã€‚" },
            "bridge": { cn: "æ¡¥", ph: "brÉªdÊ’", def: "è¿‡æ²³çš„å»ºç­‘ã€‚" },
            "nu": { cn: "æ€’(æ±Ÿ)", ph: "Name", def: "æ±Ÿåã€‚" },
            "river": { cn: "æ±Ÿ/æ²³", ph: "ËˆrÉªvÉ™r", def: "æ°´æµã€‚" },
            "baoshan": { cn: "ä¿å±±", ph: "Name", def: "åœ°åã€‚" },
            "yunnan": { cn: "äº‘å—", ph: "Name", def: "çœåã€‚" },
            "burma": { cn: "ç¼…ç”¸", ph: "Name", def: "å›½åã€‚" },
            "road": { cn: "è·¯", ph: "roÊŠd", def: "é“è·¯ã€‚" },
            "important": { cn: "é‡è¦çš„", ph: "ÉªmËˆpÉ”Ërtnt", def: "æœ‰ç”¨çš„ã€‚" },
            "station": { cn: "ç«™ç‚¹", ph: "ËˆsteÉªÊƒn", def: "åœ°æ–¹ã€‚" },
            "war": { cn: "æˆ˜äº‰", ph: "wÉ”Ër", def: "æ‰“ä»—ã€‚" },
            "against": { cn: "å¯¹æŠ—", ph: "É™ËˆÉ¡enst", def: "åå¯¹ã€‚" },
            "japanese": { cn: "æ—¥æœ¬çš„", ph: "ËŒdÊ’Ã¦pÉ™ËˆniËz", def: "æ—¥æœ¬çš„ã€‚" },
            "originally": { cn: "æœ€åˆ", ph: "É™ËˆrÉªdÊ’ÉªnÉ™li", def: "å¼€å§‹æ—¶ã€‚" },
            "later": { cn: "åæ¥", ph: "ËˆleÉªtÉ™r", def: "ä¹‹åã€‚" },
            "chinese": { cn: "ä¸­å›½äºº", ph: "ËŒtÊƒaÉªËˆniËz", def: "ä¸­å›½äººã€‚" },
            "stop": { cn: "åœæ­¢", ph: "stÉ‘Ëp", def: "åœä¸‹ã€‚" },
            "blew": { cn: "ç‚¸æ¯", ph: "bluË", def: "çˆ†ç‚¸ã€‚" },
            "western": { cn: "è¥¿éƒ¨çš„", ph: "ËˆwestÉ™rn", def: "è¥¿è¾¹çš„ã€‚" }
        };

        const createLevelData = (word, sceneQ, vibeOpts, surgerySyls, directorScen, contextEn, contextZh) => ({
            type: "special",
            title: `${word} ç‰¹è®­`,
            steps: [
                { id: "vibe", title: "ç¬¬ä¸€å…³ï¼šåœºæ™¯çŒœçŒœçœ‹", icon: <Smile className="w-6 h-6 text-yellow-400" />, instruction: `ã€åœºæ™¯ã€‘ï¼š${sceneQ}`, autoPlay: true, options: vibeOpts },
                { id: "surgery", title: "ç¬¬äºŒå…³ï¼šå•è¯æ‹¼è£…", icon: <Dna className="w-6 h-6 text-blue-400" />, instruction: "è¿™ä¸ªè¯å¤ªé•¿äº†ï¼Œæˆ‘ä»¬åƒæ‹¼ä¹é«˜ä¸€æ ·æŠŠå®ƒæ‹¼èµ·æ¥ï¼", syllables: surgerySyls.map(s => ({ text: s.t, meaning: s.m })), correctOrder: surgerySyls.map(s => s.t), explanation: "ğŸ‰ æ‹¼å¯¹äº†ï¼è®°ä½è¿™äº›å°ç§¯æœ¨ï¼Œä¸‹æ¬¡å°±èƒ½çŒœå‡ºæ„æ€å•¦ï¼" },
                { id: "director", title: "ç¬¬ä¸‰å…³ï¼šæˆ‘æ˜¯å°å¯¼æ¼”", icon: <Clapperboard className="w-6 h-6 text-purple-400" />, instruction: "çœ‹çœ‹ä¸‹é¢çš„å‰§æœ¬ï¼Œé€‰å“ªä¸ªè¯æœ€åˆé€‚ï¼Ÿ", scenario: directorScen.q, action: directorScen.a, options: directorScen.opts, originalWord: word },
                { id: "speak", title: "ç¬¬å››å…³ï¼šå‘éŸ³è¯„æµ‹", icon: <Mic className="w-6 h-6 text-red-400" />, instruction: "ç‚¹å‡»éº¦å…‹é£ï¼Œå¤§å£°è¯»å‡ºè¿™ä¸ªè¯ï¼", targetWord: word },
                { id: "context", title: "ç»ˆå±€ï¼šå›åˆ°è¯¾æ–‡", icon: <BookOpen className="w-6 h-6 text-green-400" />, instruction: "æ­å–œé€šå…³ï¼çœ‹çœ‹è¿™ä¸ªè¯åœ¨è¯¾æ–‡é‡Œæ˜¯æ€ä¹ˆç”¨çš„ã€‚", contextData: { en: contextEn, zh: contextZh } }
            ]
        });

        const RICH_LEVELS = {
            "Reluctantly": createLevelData("Reluctantly", "å£«å…µä»¬ä¸ºäº†é˜»æŒ¡æ•Œäººï¼Œå¿…é¡»äº²æ‰‹ç‚¸æ‰å¿ƒçˆ±çš„æ¡¥ã€‚å¿ƒé‡Œæ€ä¹ˆæƒ³ï¼Ÿ", [{id:"A", emoji:"ğŸ˜†", text:"Happily (å¼€å¿ƒ)", correct:false, feedback:"æ€ä¹ˆä¼šå¼€å¿ƒå‘¢ï¼Ÿ"}, {id:"B", emoji:"ğŸ˜“", text:"Reluctantly (ä¸æƒ…æ„¿)", correct:true, feedback:"å¯¹ï¼å¿ƒé‡Œä¸€ç™¾ä¸ªä¸æ„¿æ„ã€‚"}], [{t:"Re",m:"å‘å"}, {t:"luct",m:"æŒ£æ‰"}, {t:"ant",m:"...çš„"}, {t:"ly",m:"...åœ°"}], {q:"å¦ˆå¦ˆè¯´ï¼š'åˆ«ç©äº†ï¼Œå¿«å»å†™ä½œä¸šï¼'", a:"æˆ‘ _____ åœ°è¯´ï¼š'å¥½å§...' (å¿ƒé‡Œè¿˜æƒ³ç©)", opts:[{text:"Happily", correct:false}, {text:"Reluctantly", correct:true}]}, "The troops **reluctantly** blew up the bridge.", "å®ˆå†›**ä¸æƒ…æ„¿åœ°**ç‚¸æ¯äº†è¿™åº§æ¡¥ã€‚"),
            "Aggression": createLevelData("Aggression", "åäººä¸è®²é“ç†ï¼Œå†²è¿›åˆ«äººå®¶é‡Œæ‰“ç ¸æŠ¢ã€‚è¿™ç§è¡Œä¸ºå«ï¼Ÿ", [{id:"A", emoji:"ğŸ˜¡", text:"Aggression (ä¾µç•¥)", correct:true, feedback:"æ²¡é”™ï¼Œé‡è›®çš„ä¾µç•¥ã€‚"}, {id:"B", emoji:"ğŸ¤", text:"Friendly (å‹è°Š)", correct:false, feedback:"è¿™ä¸æ˜¯äº¤æœ‹å‹ã€‚"}], [{t:"Ag",m:"å»"}, {t:"gres",m:"èµ°"}, {t:"sion",m:"åè¯"}], {q:"åå­©å­åœ¨å­¦æ ¡æ¬ºè´Ÿäººã€‚", a:"è¿™æ˜¯ä¸€ç§ _____ çš„è¡Œä¸ºã€‚", opts:[{text:"Aggression", correct:true}, {text:"Kindness", correct:false}]}, "War against Japanese **Aggression**.", "æŠ—æ—¥**ä¾µç•¥**æˆ˜äº‰ã€‚"),
            "Resistance": createLevelData("Resistance", "æœ‰äººæ¬ºè´Ÿä½ ï¼Œä½ å‹‡æ•¢åœ°æ¨å¼€ä»–ï¼Œä¿æŠ¤è‡ªå·±ã€‚è¿™å«ï¼Ÿ", [{id:"A", emoji:"ğŸ›¡ï¸", text:"Resistance (æŠµæŠ—)", correct:true, feedback:"å¯¹ï¼ä¿æŠ¤è‡ªå·±ã€‚"}, {id:"B", emoji:"ğŸ³ï¸", text:"Giving up (æ”¾å¼ƒ)", correct:false, feedback:"ä¸èƒ½æ”¾å¼ƒå“¦ã€‚"}], [{t:"Re",m:"å"}, {t:"sist",m:"ç«™ç«‹"}, {t:"ance",m:"åè¯"}], {q:"ç—…æ¯’å…¥ä¾µèº«ä½“ï¼Œç™½ç»†èƒä¼šæ€æ ·ï¼Ÿ", a:"å®ƒä»¬ä¼šç»„ç»‡ _____ã€‚", opts:[{text:"Resistance", correct:true}, {text:"Party", correct:false}]}, "War of **Resistance**.", "**æŠµæŠ—**æˆ˜äº‰ã€‚"),
            "Military": createLevelData("Military", "çœ‹åˆ°è¿·å½©æœã€å¦å…‹å’Œæ•´é½çš„å£«å…µé˜Ÿä¼ã€‚è¿™æ˜¯ä»€ä¹ˆï¼Ÿ", [{id:"A", emoji:"ğŸ’‚", text:"Military (å†›äº‹)", correct:true, feedback:"Bingo! å†›é˜Ÿç›¸å…³ã€‚"}, {id:"B", emoji:"ğŸ‘¨â€ğŸ³", text:"Cooking (åšé¥­)", correct:false, feedback:"ä¸æ˜¯åšé¥­å“¦ã€‚"}], [{t:"Mili",m:"å£«å…µ"}, {t:"tary",m:"...çš„"}], {q:"çˆ¸çˆ¸å¼€ç€ç»¿è‰²çš„å¡è½¦ã€‚", a:"è¿™æ˜¯ä¸€è¾† _____ vehicle (è½¦)ã€‚", opts:[{text:"Military", correct:true}, {text:"Toy", correct:false}]}, "An important **military** station.", "ä¸€ä¸ªé‡è¦çš„**å†›äº‹**ç«™ç‚¹ã€‚"),
            "Troops": createLevelData("Troops", "æ“åœºä¸Šç«™ç€ä¸€å¤§ç¾¤ç©¿ç€åˆ¶æœçš„å£«å…µã€‚ä»–ä»¬æ˜¯ï¼Ÿ", [{id:"A", emoji:"ğŸ‘¥", text:"Troops (éƒ¨é˜Ÿ)", correct:true, feedback:"å¯¹ï¼ä¸€ç¾¤å£«å…µã€‚"}, {id:"B", emoji:"ğŸŒ²", text:"Trees (æ ‘)", correct:false, feedback:"ä¸æ˜¯æ ‘å“¦ã€‚"}], [{t:"Troop",m:"é˜Ÿä¼"}, {t:"s",m:"å¤æ•°"}], {q:"æŒ‡æŒ¥å®˜ä¸‹ä»¤ï¼šå…¨å†›å‡ºå‡»ï¼", a:"The _____ moved forward.", opts:[{text:"Troops", correct:true}, {text:"Cats", correct:false}]}, "The defending **troops** blew up the bridge.", "é˜²å®ˆ**éƒ¨é˜Ÿ**ç‚¸æ¯äº†æ¡¥ã€‚"),
            "Vital": createLevelData("Vital", "é±¼å„¿ç¦»ä¸å¼€æ°´ï¼Œäººç¦»ä¸å¼€ç©ºæ°”ã€‚è¿™å«ï¼Ÿ", [{id:"A", emoji:"ğŸ’§", text:"Vital (è‡³å…³é‡è¦)", correct:true, feedback:"åƒç»´ä»–å‘½ä¸€æ ·é‡è¦ã€‚"}, {id:"B", emoji:"ğŸ—‘ï¸", text:"Useless (æ²¡ç”¨)", correct:false, feedback:"éå¸¸æœ‰ç”¨ï¼"}], [{t:"Vit",m:"ç”Ÿå‘½"}, {t:"al",m:"...çš„"}], {q:"å¿ƒè„å¯¹äººæ¥è¯´æ˜¯ï¼Ÿ", a:"The heart is ______.", opts:[{text:"Vital", correct:true}, {text:"Optional", correct:false}]}, "A **vital** passage.", "**è‡³å…³é‡è¦çš„**é€šé“ã€‚"),
            "Crucial": createLevelData("Crucial", "æœ€åçš„ä¸€åˆ†é’Ÿï¼Œè¿›çƒå°±èƒ½èµ¢ï¼Œä¸è¿›å°±è¾“ã€‚è¿™ä¸€åˆ»æ˜¯ï¼Ÿ", [{id:"A", emoji:"ğŸ—ï¸", text:"Crucial (å…³é”®)", correct:true, feedback:"å†³å®šæ€§çš„æ—¶åˆ»ã€‚"}, {id:"B", emoji:"ğŸ˜´", text:"Boring (æ— èŠ)", correct:false, feedback:"ä¸€ç‚¹ä¹Ÿä¸æ— èŠã€‚"}], [{t:"Cruc",m:"åå­—"}, {t:"ial",m:"...çš„"}], {q:"è¿™æ˜¯è€ƒè¯•ä¸­æœ€éš¾çš„ä¸€é¢˜ã€‚", a:"It is a ______ question.", opts:[{text:"Crucial", correct:true}, {text:"Funny", correct:false}]}, "A **crucial** turning point.", "ä¸€ä¸ª**å…³é”®çš„**è½¬æŠ˜ç‚¹ã€‚"),
            "Donations": createLevelData("Donations", "å¤§å®¶æŠŠé›¶èŠ±é’±æ”¾è¿›çº¢ç®±å­å¸®åŠ©ç©·äººã€‚è¿™äº›é’±å«ï¼Ÿ", [{id:"A", emoji:"ğŸ", text:"Donations (ææ¬¾)", correct:true, feedback:"çˆ±å¿ƒæèµ ã€‚"}, {id:"B", emoji:"ğŸ’¸", text:"Fine (ç½šæ¬¾)", correct:false, feedback:"ä¸æ˜¯åšé”™äº‹äº¤é’±ã€‚"}], [{t:"Don",m:"ç»™"}, {t:"ations",m:"å"}], {q:"æˆ‘ä»¬ç»™å­¤å„¿é™¢é€å»äº†ï¼Ÿ", a:"We gave ______.", opts:[{text:"Donations", correct:true}, {text:"Trash", correct:false}]}, "With **donations**.", "å¸¦ç€**ææ¬¾**ã€‚"),
            "Overseas": createLevelData("Overseas", "é£è¿‡å¤§æµ·ï¼Œåˆ°äº†åˆ«çš„å›½å®¶ã€‚é‚£é‡Œæ˜¯ï¼Ÿ", [{id:"A", emoji:"ğŸŒŠ", text:"Overseas (æµ·å¤–)", correct:true, feedback:"è¶Šè¿‡å¤§æµ·ã€‚"}, {id:"B", emoji:"ğŸ ", text:"Home (å®¶)", correct:false, feedback:"åœ¨å›½å¤–å“¦ã€‚"}], [{t:"Over",m:"è¶Šè¿‡"}, {t:"seas",m:"æµ·"}], {q:"ä»–åœ¨å›½å¤–è¯»ä¹¦ã€‚", a:"He studies ______.", opts:[{text:"Overseas", correct:true}, {text:"Here", correct:false}]}, "From **overseas** Chinese.", "æ¥è‡ª**æµ·å¤–**åäººã€‚"),
            "Turning point": createLevelData("Turning point", "ä¸€ç›´åœ¨è¾“ï¼Œçªç„¶èµ¢äº†ä¸€å±€ï¼Œåé¢å…¨èµ¢äº†ã€‚é‚£ä¸€å±€æ˜¯ï¼Ÿ", [{id:"A", emoji:"â†©ï¸", text:"Turning point (è½¬æŠ˜ç‚¹)", correct:true, feedback:"å±€åŠ¿å˜äº†ã€‚"}, {id:"B", emoji:"ğŸ›‘", text:"Stop (åœ)", correct:false, feedback:"æ²¡åœï¼Œæ˜¯å˜å¥½äº†ã€‚"}], [{t:"Turn",m:"è½¬"}, {t:"ing",m:"ing"}, {t:"Point",m:"ç‚¹"}], {q:"é‚£ä¸ªè¿›çƒæ”¹å˜äº†æ¯”èµ›ã€‚", a:"It was the ______.", opts:[{text:"Turning point", correct:true}, {text:"End", correct:false}]}, "A crucial **turning point**.", "å…³é”®**è½¬æŠ˜ç‚¹**ã€‚"),
            "Suspension": createLevelData("Suspension", "æ¡¥æ²¡æœ‰æ¡¥å¢©ï¼Œè€Œæ˜¯è¢«å¤§ç¼†ç»³åŠåœ¨ç©ºä¸­ã€‚å«ï¼Ÿ", [{id:"A", emoji:"ğŸŒ", text:"Suspension (æ‚¬ç´¢)", correct:true, feedback:"æŒ‚åœ¨ç©ºä¸­ã€‚"}, {id:"B", emoji:"ğŸ§±", text:"Stone (çŸ³å¤´)", correct:false, feedback:"ä¸æ˜¯çŸ³å¤´å †çš„ã€‚"}], [{t:"Sus",m:"ä¸‹"}, {t:"pen",m:"æŒ‚"}, {t:"sion",m:"å"}], {q:"é‡‘é—¨å¤§æ¡¥é ç¼†ç»³æ‹‰ç€ã€‚", a:"It is a ______ bridge.", opts:[{text:"Suspension", correct:true}, {text:"Paper", correct:false}]}, "An iron-chain **suspension** bridge.", "é“é“¾**æ‚¬ç´¢**æ¡¥ã€‚"),
            "Rebuilt": createLevelData("Rebuilt", "ä¹é«˜å€’äº†ï¼Œä½ åˆæŠŠå®ƒæ­èµ·æ¥ã€‚è¿™å«ï¼Ÿ", [{id:"A", emoji:"ğŸ—ï¸", text:"Rebuilt (é‡å»º)", correct:true, feedback:"å†å»ºä¸€æ¬¡ã€‚"}, {id:"B", emoji:"ğŸšï¸", text:"Broken (åäº†)", correct:false, feedback:"é‚£æ˜¯çŠ¶æ€ã€‚"}], [{t:"Re",m:"å†"}, {t:"built",m:"å»º"}], {q:"æˆ¿å­è¢«çƒ§äº†ï¼Œåæ¥å¤§å®¶åˆç›–äº†æ–°çš„ã€‚", a:"The house was ______.", opts:[{text:"Rebuilt", correct:true}, {text:"Sold", correct:false}]}, "It was later **rebuilt**.", "åæ¥è¢«**é‡å»º**ã€‚"),
            "Located": createLevelData("Located", "åœ¨åœ°å›¾ä¸Šæ‰¾å­¦æ ¡ï¼Œå®ƒåœ¨å…¬å›­æ—è¾¹ã€‚å®ƒ _____ å…¬å›­æ—ã€‚", [{id:"A", emoji:"ğŸ“", text:"Located (ä½äº)", correct:true, feedback:"ä½ç½®åœ¨å“ªé‡Œã€‚"}, {id:"B", emoji:"ğŸƒ", text:"Running (è·‘)", correct:false, feedback:"å­¦æ ¡ä¸è·‘ã€‚"}], [{t:"Loc",m:"åœ°æ–¹"}, {t:"ated",m:"...çš„"}], {q:"åŒ—äº¬åœ¨å“ªï¼Ÿ", a:"Beijing is ______ in China.", opts:[{text:"Located", correct:true}, {text:"Hidden", correct:false}]}, "The bridge is **located** on Nu River.", "æ¡¥**ä½äº**æ€’æ±Ÿä¸Šã€‚"),
            "Advance": createLevelData("Advance", "èµ›è·‘æ—¶ï¼Œä½ åŠªåŠ›å‘å‰å†²ã€‚è¿™ä¸ªåŠ¨ä½œæ˜¯ï¼Ÿ", [{id:"A", emoji:"â©", text:"Advance (å‰è¿›)", correct:true, feedback:"å‘å‰è¿›ï¼"}, {id:"B", emoji:"âª", text:"Retreat (åé€€)", correct:false, feedback:"é‚£æ˜¯å¾€å›è·‘ã€‚"}], [{t:"Ad",m:"å»"}, {t:"vance",m:"å‰"}], {q:"ä¸ºäº†èµ¢å¾—æ¯”èµ›ï¼Œæˆ‘ä»¬å¿…é¡»ï¼Ÿ", a:"We must ______.", opts:[{text:"Advance", correct:true}, {text:"Sleep", correct:false}]}, "To stop the Japanese **advance**.", "ä¸ºäº†é˜»æ­¢æ—¥å†›**æ¨è¿›**ã€‚"),
            "Campaign": createLevelData("Campaign", "ä¸ºäº†èµ¢å¾—æˆ˜äº‰æˆ–é€‰ä¸¾ï¼Œè¿›è¡Œçš„ä¸€ç³»åˆ—å¤§åŠ¨ä½œã€‚å«ï¼Ÿ", [{id:"A", emoji:"ğŸš©", text:"Campaign (æˆ˜å½¹)", correct:true, feedback:"ä¸€ç³»åˆ—è¡ŒåŠ¨ã€‚"}, {id:"B", emoji:"â›º", text:"Camping (éœ²è¥)", correct:false, feedback:"éœ²è¥æ˜¯å»ç©ã€‚"}], [{t:"Cam",m:"å¹³åŸ"}, {t:"paign",m:"è¡ŒåŠ¨"}], {q:"ä¸ºäº†ä¿æŠ¤ç¯å¢ƒï¼Œå­¦æ ¡å‘èµ·äº†ï¼Ÿ", a:"A recycling ______.", opts:[{text:"Campaign", correct:true}, {text:"Lunch", correct:false}]}, "The Western Yunnan **campaign**.", "æ»‡è¥¿**æˆ˜å½¹**ã€‚"),
            "Passage": createLevelData("Passage", "ä¸¤ä¸ªæˆ¿é—´ä¸­é—´æœ‰ä¸€æ¡çª„çª„çš„è·¯ã€‚è¿™å«ï¼Ÿ", [{id:"A", emoji:"ğŸ›¤ï¸", text:"Passage (é€šé“)", correct:true, feedback:"å¯ä»¥é€šè¿‡çš„è·¯ã€‚"}, {id:"B", emoji:"ğŸ§±", text:"Wall (å¢™)", correct:false, feedback:"å¢™è¿‡ä¸å»ã€‚"}], [{t:"Pass",m:"é€šè¿‡"}, {t:"age",m:"å"}], {q:"è¿™æ˜¯ä¸€æ¡ç§˜å¯†çš„ï¼Ÿ", a:"A secret ______.", opts:[{text:"Passage", correct:true}, {text:"Apple", correct:false}]}, "A vital **passage**.", "ä¸€æ¡é‡è¦**é€šé“**ã€‚"),
            "Iron-chain": createLevelData("Iron-chain", "ä»¥å‰çš„æ¡¥æ²¡æœ‰é’¢ç¼†ï¼Œç”¨å¾ˆç²—çš„é“ç¯æ‰£åœ¨ä¸€èµ·ã€‚å«ï¼Ÿ", [{id:"A", emoji:"â›“ï¸", text:"Iron-chain (é“é“¾)", correct:true, feedback:"é“åšçš„é“¾å­ã€‚"}, {id:"B", emoji:"ğŸ§µ", text:"Thread (çº¿)", correct:false, feedback:"çº¿å¤ªç»†äº†ã€‚"}], [{t:"Iron",m:"é“"}, {t:"Chain",m:"é“¾"}], {q:"è¿™ä¸ªç§‹åƒæ˜¯ç”¨ä»€ä¹ˆæŒ‚ç€çš„ï¼Ÿ", a:"Strong ______.", opts:[{text:"Iron-chains", correct:true}, {text:"Noodles", correct:false}]}, "An **iron-chain** bridge.", "ä¸€åº§**é“é“¾**æ¡¥ã€‚"),
            "Steel-cable": createLevelData("Steel-cable", "ç°ä»£å¤§æ¡¥ç”¨çš„ï¼Œæ¯”é“é“¾æ›´å¼ºï¼Œåƒå·¨å¤§çš„é’¢ç»³ã€‚å«ï¼Ÿ", [{id:"A", emoji:"ğŸŒ‰", text:"Steel-cable (é’¢ç¼†)", correct:true, feedback:"é’¢åšçš„ç¼†ç»³ã€‚"}, {id:"B", emoji:"ğŸ§¶", text:"Wool (æ¯›çº¿)", correct:false, feedback:"æ¯›çº¿æ‹‰ä¸ä½æ¡¥ã€‚"}], [{t:"Steel",m:"é’¢"}, {t:"Cable",m:"ç¼†"}], {q:"ç”µæ¢¯ä¹Ÿæ˜¯é è¿™ä¸ªæ‹‰çš„ã€‚", a:"Strong ______.", opts:[{text:"Steel-cables", correct:true}, {text:"Hair", correct:false}]}, "A **steel-cable** bridge.", "ä¸€åº§**é’¢ç¼†**æ¡¥ã€‚")
        };

        const WORD_GALAXIES = [
            { id: 'war', name: 'Military & War', cnName: 'å†›äº‹ä¸æˆ˜äº‰ç¯‡', icon: <Shield className="w-6 h-6 text-red-400" />, words: ['Reluctantly', 'Aggression', 'Military', 'Defending', 'Resistance', 'Troops', 'Advance', 'Campaign'] },
            { id: 'struct', name: 'Construction & Location', cnName: 'å»ºç­‘ä¸åœ°ç†ç¯‡', icon: <Hammer className="w-6 h-6 text-yellow-400" />, words: ['Suspension', 'Rebuilt', 'Located', 'Passage', 'Iron-chain', 'Steel-cable'] },
            { id: 'core', name: 'Core Vocabulary', cnName: 'æ ¸å¿ƒè¯æ±‡ç¯‡', icon: <Globe className="w-6 h-6 text-blue-400" />, words: ['Vital', 'Donations', 'Overseas', 'Turning point', 'Crucial'] }
        ];

        /* ==========================================
           COMPONENTS & LOGIC
           ========================================== */
        
        // æ™ºèƒ½æœ—è¯» Hook (å¢å¼ºè¯­éŸ³åŒ…åŠ è½½ç¨³å®šæ€§)
        const useSmartSpeaker = () => {
            const [isPlaying, setIsPlaying] = useState(false);
            
            const speak = (text) => {
                window.speechSynthesis.cancel();
                setIsPlaying(true);
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.85; 
                
                const voices = window.speechSynthesis.getVoices();
                const preferredVoice = voices.find(v => v.name.includes("Google US English")) || 
                                       voices.find(v => v.name.includes("Samantha")) ||
                                       voices.find(v => v.lang === 'en-US');
                if (preferredVoice) utterance.voice = preferredVoice;

                utterance.onend = () => setIsPlaying(false);
                utterance.onerror = () => setIsPlaying(false);
                window.speechSynthesis.speak(utterance);
            };

            useEffect(() => { 
                const loadVoices = () => { window.speechSynthesis.getVoices(); };
                loadVoices();
                if (window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = loadVoices;
                }
            }, []);
            
            return { speak, isPlaying };
        };

        // ç›¸ä¼¼åº¦ç®—æ³•
        const calculateSimilarity = (str1, str2) => {
            const s1 = str1.toLowerCase().trim();
            const s2 = str2.toLowerCase().trim();
            if (s1 === s2) return 100;
            if (s1.includes(s2) || s2.includes(s1)) return 85; 
            return 60; // æ¨¡æ‹Ÿåˆ†
        };

        // æ¨¡æ‹Ÿ AI ç”Ÿæˆ
        const generateMockStory = (words) => {
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve({
                        english: `The hero acted **${words[0]||'bravely'}** and made a **${words[1]||'crucial'}** decision to cross the **bridge**. It was amazing!`,
                        chinese: `ä¸»è§’è¡¨ç°å¾—${VOCAB_DICTIONARY[words[0]?.toLowerCase()]?.cn||'å‹‡æ•¢'}ï¼Œåšå‡ºäº†ä¸€ä¸ª${VOCAB_DICTIONARY[words[1]?.toLowerCase()]?.cn||'å…³é”®'}çš„å†³å®šå»è¿‡æ¡¥ã€‚å¤ªæ£’äº†ï¼(ç¦»çº¿æ¨¡å¼ç”Ÿæˆ)`
                    });
                }, 1500);
            });
        };

        // Tooltip Context
        const TooltipContext = createContext();
        
        const TooltipProvider = ({ children }) => {
            const [tooltip, setTooltip] = useState({ visible: false, x: 0, y: 0, word: '', data: null });
            const { speak } = useSmartSpeaker();

            const showTooltip = (e, word, data) => {
                let x = e.clientX;
                let y = e.clientY + 20;
                // æ‰‹æœºç«¯é€‚é…
                if (x > window.innerWidth - 220) x = window.innerWidth - 230;
                if (x < 10) x = 10;
                if (y > window.innerHeight - 150) y = e.clientY - 140; // æ˜¾ç¤ºåœ¨ä¸Šæ–¹
                
                setTooltip({ visible: true, x, y, word, data });
            };

            const hideTooltip = () => setTooltip(prev => ({ ...prev, visible: false }));

            useEffect(() => {
                const handleGlobalClick = () => hideTooltip();
                window.addEventListener('click', handleGlobalClick);
                return () => window.removeEventListener('click', handleGlobalClick);
            }, []);

            return (
                <TooltipContext.Provider value={{ showTooltip, hideTooltip, speak }}>
                    {children}
                    {tooltip.visible && tooltip.data && (
                        <div 
                            className="fixed z-50 bg-slate-800 border border-yellow-500/50 rounded-xl shadow-2xl p-4 w-60 animate-fade-in-up"
                            style={{ top: tooltip.y, left: tooltip.x }}
                            onClick={(e) => e.stopPropagation()}
                        >
                            <div className="flex justify-between items-start mb-2">
                                <h3 className="text-xl font-bold text-yellow-400 capitalize">{tooltip.word}</h3>
                                <button onClick={() => speak(tooltip.word)} className="p-1.5 bg-blue-600 rounded-full hover:bg-blue-500 active:scale-95 transition-transform"><Volume2 className="w-4 h-4 text-white" /></button>
                            </div>
                            <div className="flex items-center gap-2 text-slate-400 text-sm mb-2 font-mono border-b border-slate-700 pb-1"><span>/{tooltip.data.ph}/</span></div>
                            <p className="text-white font-bold mb-1 text-lg">{tooltip.data.cn}</p>
                            <p className="text-sm text-slate-400 italic leading-tight">{tooltip.data.def}</p>
                        </div>
                    )}
                </TooltipContext.Provider>
            );
        };

        const SmartText = ({ text, className = "", highlightWord }) => {
            const { showTooltip, hideTooltip, speak } = useContext(TooltipContext);
            const parts = text.split(/([a-zA-Z0-9-]+)/g);

            return (
                <span className={className}>
                    {parts.map((part, i) => {
                        const cleanWord = part.toLowerCase();
                        const vocabData = VOCAB_DICTIONARY[cleanWord];
                        const isHighlight = highlightWord && cleanWord.includes(highlightWord.toLowerCase());

                        if (vocabData || /^[a-zA-Z]+$/.test(cleanWord)) {
                            const data = vocabData || { cn: "ç‚¹å‡»å‘éŸ³", ph: "", def: "" };
                            return (
                                <span
                                    key={i}
                                    className={`relative cursor-pointer transition-all rounded px-0.5 border-b-2 inline-block mx-0.5 active:bg-yellow-500/30
                                        ${isHighlight ? 'bg-yellow-400/20 text-yellow-300 border-yellow-400 font-bold' : 'border-transparent hover:bg-blue-500/20 hover:text-blue-300 hover:border-blue-400'}
                                    `}
                                    onClick={(e) => { 
                                        e.stopPropagation(); 
                                        showTooltip(e, cleanWord, data); 
                                        speak(part); 
                                    }}
                                >
                                    {part}
                                </span>
                            );
                        }
                        return <span key={i} className="text-slate-400">{part}</span>;
                    })}
                </span>
            );
        };

        const VoiceChallenge = ({ targetWord, onSuccess }) => {
            const [status, setStatus] = useState("idle");
            const [score, setScore] = useState(0);
            const { speak } = useSmartSpeaker();

            const startListening = () => {
                if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) { 
                    alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨ Chrome æµè§ˆå™¨ä½“éªŒå‘éŸ³è¯„æµ‹åŠŸèƒ½ã€‚"); 
                    return; 
                }
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
                
                try {
                    recognition.start();
                    setStatus("listening");
                } catch(err) {
                    console.error("Speech Recognition Error:", err);
                    setStatus("error");
                }
                
                recognition.onresult = (e) => {
                    const heard = e.results[0][0].transcript;
                    setStatus("processing");
                    const sim = calculateSimilarity(heard, targetWord);
                    setScore(sim);
                    setTimeout(() => {
                        if (sim >= 60) { setStatus("success"); setTimeout(onSuccess, 2000); } 
                        else { setStatus("error"); }
                    }, 800);
                };
                recognition.onerror = (e) => {
                    if (e.error === 'not-allowed') {
                        alert("æ£€æµ‹ä¸åˆ°éº¦å…‹é£æƒé™å“¦ï¼Œè¯·åœ¨æµè§ˆå™¨åœ°å€æ å·¦ä¾§å…è®¸éº¦å…‹é£æƒé™ï¼");
                    }
                    setStatus("error");
                };
                recognition.onend = () => { if(status==='listening') setStatus('idle'); };
            };

            return (
                <div className="flex flex-col items-center">
                    <div className="relative mb-8 mt-4 group">
                        {status==='listening' && <div className="absolute inset-0 bg-red-500 rounded-full animate-ping opacity-20"></div>}
                        <button onClick={startListening} disabled={status==='success'} className={`w-24 h-24 rounded-full flex items-center justify-center border-4 transition-all transform active:scale-95 shadow-xl ${status==='listening'?'border-red-500 text-red-500 scale-110':status==='success'?'border-green-500 text-green-500 bg-green-500/10':'border-slate-600 hover:border-blue-400 bg-slate-800'}`}>
                            {status==='success' ? <Check className="w-10 h-10"/> : <Mic className="w-10 h-10"/>}
                        </button>
                    </div>
                    <div className="min-h-[80px] w-full text-center px-4">
                        {status === 'idle' && <p className="text-slate-400 text-lg">ç‚¹å‡»éº¦å…‹é£ï¼Œå¤§å£°è¯»å‡ºå•è¯</p>}
                        {status === 'listening' && <p className="text-red-400 font-bold text-lg animate-pulse">æ­£åœ¨è†å¬...è¯·å¤§å£°æœ—è¯»</p>}
                        {status === 'processing' && <p className="text-blue-400 text-lg animate-pulse">æ­£åœ¨åˆ†æå‘éŸ³...</p>}
                        {status === 'success' && <p className="text-green-400 font-bold text-2xl animate-bounce">{score >= 90 ? "Excellent! å®Œç¾!" : "Good Job! å¾ˆæ£’!"}</p>}
                        {status === 'error' && <p className="text-orange-400 font-bold">æ²¡å¬æ¸…æˆ–è¢«æ‹’ç»æƒé™ï¼Œå†è¯•ä¸€æ¬¡ï¼</p>}
                    </div>
                    <button onClick={() => speak(targetWord)} className="mt-4 text-sm bg-slate-800 hover:bg-slate-700 text-blue-400 px-4 py-2 rounded-full flex items-center gap-2 border border-slate-700"><Volume2 className="w-4 h-4"/> å¬æ ‡å‡†ç¤ºèŒƒ</button>
                </div>
            );
        };

        const UniversalLevel = ({ word, onBack, onComplete }) => {
            const defaultData = createLevelData(word, "åŠ è½½ä¸­...", [], [], {q:"",a:"",opts:[]}, "", "");
            const data = RICH_LEVELS[word] || defaultData;
            const [currentStep, setCurrentStep] = useState(0);
            const [feedback, setFeedback] = useState(null); 
            const [feedbackMsg, setFeedbackMsg] = useState("");
            const [surgeryInput, setSurgeryInput] = useState([]);
            const { speak, isPlaying } = useSmartSpeaker();

            useEffect(() => { 
                setFeedback(null); setFeedbackMsg(""); setSurgeryInput([]);
                if (data.steps[currentStep].autoPlay) setTimeout(() => speak(word), 500);
            }, [currentStep, word]);

            const stepData = data.steps[currentStep];

            const handleSurgeryClick = (item) => {
                if (feedback === 'success') return;
                const newSeq = [...surgeryInput, item];
                setSurgeryInput(newSeq);
                if (newSeq.length === stepData.correctOrder.length) {
                    const isCorrect = newSeq.map(i=>i.text).join('') === stepData.correctOrder.join('');
                    if (isCorrect) { setFeedback('success'); setFeedbackMsg(stepData.explanation); speak(word); }
                    else { setFeedback('error'); setFeedbackMsg("é¡ºåºä¸å¯¹å“¦ï¼"); }
                }
            };

            return (
                <div className="flex flex-col h-full bg-slate-900 text-white overflow-y-auto animate-fade-in-up">
                    <div className="p-4 bg-slate-800 flex justify-between items-center border-b border-slate-700 sticky top-0 z-20">
                        <button onClick={onBack} className="text-slate-400 hover:text-white flex items-center gap-2"><ArrowRight className="rotate-180 w-5 h-5" /> é€€å‡º</button>
                        <div className="flex items-center gap-4"><h2 className="text-xl font-bold text-yellow-400 flex items-center gap-2"><Star className="text-yellow-400 w-5 h-5" style={{ fill: "currentColor" }} /> {word}</h2></div>
                        <div className="w-8"></div>
                    </div>
                    <div className="flex-1 p-6 max-w-2xl mx-auto w-full flex flex-col items-center">
                        <div className="flex gap-2 mb-8">
                            {data.steps.map((_, idx) => <div key={`dot-${idx}`} className={`h-2 rounded-full transition-all duration-300 ${idx === currentStep ? 'bg-blue-500 w-8' : idx < currentStep ? 'bg-green-500 w-2' : 'bg-slate-700 w-2'}`}></div>)}
                        </div>
                        <div className="bg-slate-800 p-8 rounded-2xl border border-slate-700 w-full shadow-2xl relative min-h-[500px] flex flex-col">
                            <div className="flex items-center justify-between mb-6 border-b border-slate-700 pb-4">
                                <div className="flex items-center gap-3"><div className="p-2 bg-slate-700 rounded-lg">{stepData.icon}</div><h3 className="text-xl font-bold">{stepData.title}</h3></div>
                                <button onClick={() => speak(word)} className={`p-2 rounded-full transition-all ${isPlaying ? 'bg-blue-500/20 text-blue-400 ring-2 ring-blue-500' : 'bg-slate-700 text-slate-300'}`}><Volume2 className="w-5 h-5" /></button>
                            </div>
                            <div className="mb-8 font-medium text-lg text-slate-300 text-center">{stepData.instruction}</div>
                            <div className="flex-1 flex flex-col items-center justify-center w-full">
                                {stepData.id === 'vibe' && <div className="grid grid-cols-2 gap-4 w-full">{stepData.options.map((opt) => <button key={opt.id} onClick={() => {setFeedback(opt.correct?'success':'error'); setFeedbackMsg(opt.feedback)}} className={`p-6 rounded-xl border-2 flex flex-col items-center gap-4 transition-all ${feedback==='success'&&opt.correct?'bg-green-900/30 border-green-500':feedback==='error'&&!opt.correct?'bg-red-900/20 border-red-500 opacity-50':'bg-slate-700 border-slate-600 hover:border-blue-400'}`}><span className="text-5xl">{opt.emoji}</span><span className="font-bold text-slate-200">{opt.text}</span></button>)}</div>}
                                {stepData.id === 'surgery' && <div className="w-full"><div className={`min-h-[80px] bg-slate-900 rounded-xl border-2 mb-8 flex flex-wrap items-center justify-center gap-2 p-4 transition-colors ${feedback==='success'?'border-green-500':'border-slate-700'}`}>{surgeryInput.length===0 ? <span className="text-sm text-slate-600">ç‚¹å‡»ç¢ç‰‡æ‹¼è£…</span> : surgeryInput.map((it,i) => <button key={`surg-in-${i}`} onClick={() => {if(feedback!=='success') setSurgeryInput(p=>p.filter((_,x)=>x!==i))}} className="bg-blue-600 px-3 py-2 rounded-lg font-mono text-xl font-bold hover:bg-red-500 transition-colors">{it.text}</button>)}</div><div className="grid grid-cols-4 gap-3">{stepData.syllables.map((syl, idx) => { const isUsed = surgeryInput.filter(i=>i.text===syl.text).length >= stepData.syllables.filter(i=>i.text===syl.text).length; return <button key={`syl-${idx}`} disabled={isUsed} onClick={() => handleSurgeryClick(syl)} className={`p-2 rounded-xl border-b-4 flex flex-col items-center gap-1 transition-transform ${isUsed?'opacity-50 bg-slate-800 border-slate-800':'bg-slate-700 border-slate-900 hover:bg-blue-600 hover:-translate-y-1'}`}><span className="text-lg font-mono font-bold">{syl.text}</span><span className="text-[10px] text-yellow-300 bg-slate-900/50 px-1 rounded">{syl.meaning}</span></button>})}</div></div>}
                                {stepData.id === 'director' && <div className="w-full relative"><div className="bg-slate-900/50 p-6 rounded-xl border border-slate-600 mb-8 text-left text-lg"><p className="mb-4 text-slate-400 italic">"{stepData.scenario}"</p><p className="text-white text-2xl font-bold">{stepData.action.split("______").map((part,i)=><React.Fragment key={`dir-${i}`}>{part}{i===0 && <span className="text-yellow-400 border-b-2 border-dashed px-2">???</span>}</React.Fragment>)}</p></div><div className="grid grid-cols-1 gap-3">{stepData.options.map((opt, idx) => <button key={`opt-${idx}`} onClick={() => {setFeedback(opt.correct?'success':'error'); setFeedbackMsg(opt.correct ? "Excellent! ä½ é€‰å¯¹äº†ï¼" : "ä¸å¤ªå¯¹å“¦ï¼Œå†æƒ³æƒ³æƒ…å¢ƒã€‚")}} className="px-6 py-4 bg-slate-700 hover:bg-indigo-600 transition-colors rounded-xl font-bold text-lg text-left flex justify-between group">{opt.text} <ArrowRight className="w-5 opacity-0 group-hover:opacity-100 transition-opacity"/></button>)}</div></div>}
                                {stepData.id === 'speak' && <VoiceChallenge targetWord={stepData.targetWord} onSuccess={() => setCurrentStep(prev=>prev+1)} />}
                                {stepData.id === 'context' && <div className="text-center w-full animate-fade-in-up"><div className="bg-slate-900 p-6 rounded-xl border border-slate-700 mb-6 text-left"><div className="text-xl leading-relaxed font-serif text-white mb-4"><SmartText text={stepData.contextData.en.replace(/\*\*/g, '')} highlightWord={word} /></div><div className="h-px bg-slate-700 w-full mb-4"></div><p className="text-lg text-slate-300">{stepData.contextData.zh.replace(/\*\*/g, '')}</p></div><button onClick={() => speak(stepData.contextData.en.replace(/\*\*/g, ''))} className={`flex items-center gap-2 mx-auto text-blue-400 hover:text-white transition-colors mb-8 border border-slate-700 px-4 py-2 rounded-full ${isPlaying ? 'bg-blue-900/50' : ''}`}><Volume2 className="w-5 h-5"/> {isPlaying ? "æ­£åœ¨æœ—è¯»..." : "æœ—è¯»æ•´å¥"}</button><button onClick={() => onComplete(word)} className="px-8 py-3 bg-green-600 hover:bg-green-500 rounded-full font-bold shadow-lg flex items-center gap-2 mx-auto hover:scale-105 transition-transform">é¢†å–é€šå…³å‹‹ç«  <Star className="w-5 h-5" style={{ fill: "currentColor" }}/></button></div>}
                            </div>
                            {feedback && <div className={`absolute bottom-0 left-0 w-full p-4 text-center rounded-b-2xl animate-fade-in-up ${feedback==='success'?'bg-green-900/95 border-t-4 border-green-500':'bg-red-900/95 border-t-4 border-red-500'}`}><p className="font-bold text-lg mb-2 text-white">{feedbackMsg}</p>{feedback==='success' && <button onClick={() => setCurrentStep(prev=>prev+1)} className="px-6 py-2 bg-white text-slate-900 rounded-full font-bold hover:bg-slate-200 flex items-center gap-2 mx-auto transition-colors">ä¸‹ä¸€å…³ <ArrowRight className="w-4 h-4"/></button>}</div>}
                        </div>
                    </div>
                </div>
            );
        };

        const ReadingRoom = () => {
            const [playingIdx, setPlayingIdx] = useState(null);
            const { speak, isPlaying } = useSmartSpeaker();

            useEffect(() => { if (!isPlaying) setPlayingIdx(null); }, [isPlaying]);

            const handlePlaySentence = (text, idx) => {
                if (playingIdx === idx && isPlaying) { window.speechSynthesis.cancel(); setPlayingIdx(null); } 
                else { setPlayingIdx(idx); speak(text); }
            };

            return (
                <div className="max-w-4xl mx-auto p-6 space-y-8 animate-fade-in-up">
                    <div className="text-center mb-8"><h2 className="text-3xl font-bold text-white mb-2 font-serif">Huitong Bridge</h2><p className="text-slate-400">æƒ é€šæ¡¥ Â· å…¨æ–‡ç²¾è¯»</p></div>
                    <div className="bg-slate-800 rounded-2xl p-8 border border-slate-700 shadow-xl relative"><div className="space-y-6">{FULL_ARTICLE.map((sentence, idx) => <div key={`sent-${idx}`} className="flex gap-4 group"><button onClick={() => handlePlaySentence(sentence, idx)} className={`flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center transition-all ${playingIdx===idx ? 'bg-blue-500 text-white ring-2 ring-blue-300' : 'bg-slate-700 text-slate-400 group-hover:bg-slate-600 group-hover:text-white'}`}>{playingIdx===idx ? <div className="animate-sound-wave w-1 h-3 bg-white rounded"></div> : <Play className="w-4 h-4 ml-1"/>}</button><div className="flex-1"><p className="text-xl leading-relaxed text-slate-200 font-serif"><SmartText text={sentence} /></p></div></div>)}</div></div>
                    <div className="text-center text-slate-500 text-sm"><p>ğŸ’¡ æç¤ºï¼šæ–‡ç« ä¸­ <span className="text-yellow-400">æ¯ä¸€ä¸ªå•è¯</span> éƒ½å¯ä»¥ç‚¹å‡»æŸ¥çœ‹ç¿»è¯‘å’Œå‘éŸ³å“¦ï¼</p></div>
                </div>
            );
        };

        const CreativeLab = ({ unlockedWords }) => {
            const [selectedWords, setSelectedWords] = useState([]);
            const [story, setStory] = useState(null);
            const [loading, setLoading] = useState(false);
            const { speak, isPlaying } = useSmartSpeaker();

            const toggleWord = (word) => {
                if (selectedWords.includes(word)) setSelectedWords(prev => prev.filter(w => w !== word));
                else if (selectedWords.length < 3) setSelectedWords(prev => [...prev, word]);
            };

            const generateStory = async () => {
                if (selectedWords.length === 0) return;
                setLoading(true); setStory(null);
                const data = await generateMockStory(selectedWords);
                if (data) setStory(data);
                setLoading(false);
            };

            return (
                <div className="max-w-4xl mx-auto p-6 space-y-8 animate-fade-in-up">
                    <div className="text-center"><h2 className="text-3xl font-bold text-white mb-2 font-serif flex items-center justify-center gap-2"><PenTool className="w-8 h-8 text-pink-400"/> åˆ›æ„å®éªŒå®¤</h2><p className="text-slate-400">é€‰æ‹© 2-3 ä¸ªä½ å­¦ä¼šçš„å•è¯ï¼Œè®© AI ä¸ºä½ ç¼–ä¸€ä¸ªç¥å¥‡çš„æ•…äº‹ï¼</p></div>
                    <div className="bg-slate-800 rounded-2xl p-6 border border-slate-700">
                        <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Feather className="w-5 h-5 text-blue-400"/> é€‰æ‹©ç´ æ ({selectedWords.length}/3)</h3>
                        {unlockedWords.length === 0 ? <p className="text-slate-500 text-center py-4">ä½ è¿˜æ²¡æœ‰è§£é”ä»»ä½•å•è¯å“¦ï¼Œå¿«å»å•è¯ç‰¹è®­å§ï¼</p> : <div className="flex flex-wrap gap-3">{unlockedWords.map(word => <button key={`cw-${word}`} onClick={() => toggleWord(word)} className={`px-4 py-2 rounded-full border-2 transition-all font-medium ${selectedWords.includes(word) ? 'bg-pink-600 border-pink-400 text-white shadow-lg scale-105' : 'bg-slate-700 border-slate-600 text-slate-300 hover:border-pink-400'}`}>{word}</button>)}</div>}
                        <div className="mt-8 flex justify-center"><button onClick={generateStory} disabled={selectedWords.length === 0 || loading} className="bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white px-8 py-3 rounded-full font-bold text-lg shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">{loading ? <RefreshCw className="w-5 h-5 animate-spin"/> : <Sparkles className="w-5 h-5 text-yellow-300"/>} {loading ? "AI æ­£åœ¨åˆ›ä½œ..." : "ç”Ÿæˆå¾®å°è¯´"}</button></div>
                    </div>
                    {story && <div className="bg-gradient-to-br from-pink-900/30 to-purple-900/30 rounded-2xl p-8 border border-pink-500/30 animate-fade-in-up"><h3 className="text-xl font-bold text-pink-300 mb-4">âœ¨ æ˜Ÿé™…å¾®å°è¯´</h3><p className="text-xl leading-relaxed text-white font-serif mb-4"><SmartText text={story.english.replace(/\*\*/g, '')} /></p><div className="h-px bg-white/10 w-full mb-4"></div><p className="text-lg text-slate-300">{story.chinese}</p><button onClick={() => speak(story.english.replace(/\*\*/g, ''))} className="mt-6 flex items-center gap-2 text-pink-400 hover:text-white transition-colors bg-pink-500/10 px-4 py-2 rounded-full">{isPlaying ? <RefreshCw className="w-4 h-4 animate-spin"/> : <Volume2 className="w-5 h-5"/>} {isPlaying ? "æ­£åœ¨è®²è¿°..." : "è†å¬ AI è®²è¿°"}</button></div>}
                </div>
            );
        };

        const WordGalaxy = () => {
            const [activeTab, setActiveTab] = useState('galaxy'); 
            const [currentView, setCurrentView] = useState('main'); 
            const [selectedWord, setSelectedWord] = useState(null);
            const [completedWords, setCompletedWords] = useState([]);
            
            const handleStartLevel = (word) => { setSelectedWord(word); setCurrentView('level'); };
            const handleCompleteLevel = (word) => { if(!completedWords.includes(word)) setCompletedWords([...completedWords, word]); setCurrentView('main'); setSelectedWord(null); };

            return (
                <TooltipProvider>
                    <div className="min-h-screen bg-slate-950 text-slate-100 font-sans selection:bg-blue-500 selection:text-white flex flex-col">
                        <header className="bg-slate-900 border-b border-slate-800 sticky top-0 z-10 shadow-md">
                            <div className="max-w-5xl mx-auto px-4 h-16 flex justify-between items-center">
                                <div className="flex items-center gap-2 text-xl font-bold text-blue-400 cursor-pointer" onClick={() => { setActiveTab('galaxy'); setCurrentView('main'); }}><Rocket/> Word Galaxy</div>
                                <div className="flex bg-slate-800 p-1 rounded-lg border border-slate-700 mx-2 overflow-x-auto no-scrollbar">
                                    <button onClick={() => { setActiveTab('galaxy'); setCurrentView('main'); }} className={`px-4 py-1.5 rounded-md text-sm font-bold flex items-center gap-2 transition-all whitespace-nowrap ${activeTab === 'galaxy' && currentView === 'main' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}><Layout className="w-4 h-4" /> å•è¯ç‰¹è®­</button>
                                    <button onClick={() => { setActiveTab('reading'); setCurrentView('main'); }} className={`px-4 py-1.5 rounded-md text-sm font-bold flex items-center gap-2 transition-all whitespace-nowrap ${activeTab === 'reading' && currentView === 'main' ? 'bg-green-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}><Book className="w-4 h-4" /> å…¨æ–‡é˜…è¯»</button>
                                    <button onClick={() => { setActiveTab('creative'); setCurrentView('main'); }} className={`px-4 py-1.5 rounded-md text-sm font-bold flex items-center gap-2 transition-all whitespace-nowrap ${activeTab === 'creative' && currentView === 'main' ? 'bg-pink-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}><PenTool className="w-4 h-4" /> åˆ›æ„å®éªŒå®¤</button>
                                </div>
                                <div className="flex items-center gap-1 bg-slate-800 px-3 py-1 rounded-full border border-slate-700 text-xs flex-shrink-0"><Star className="w-3 h-3 text-yellow-400" style={{ fill: "currentColor" }}/> <span className="font-mono font-bold">{completedWords.length} / {Object.keys(RICH_LEVELS).length}</span></div>
                            </div>
                        </header>

                        <div className="flex-1">
                            {currentView === 'level' ? (
                                <UniversalLevel word={selectedWord} onBack={() => setCurrentView('main')} onComplete={handleCompleteLevel} />
                            ) : (
                                <>
                                    {activeTab === 'galaxy' && (
                                        <main className="max-w-4xl mx-auto p-6 space-y-8 animate-fade-in-up">
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div className="bg-gradient-to-br from-indigo-900 to-slate-900 rounded-2xl p-6 text-center border border-indigo-500/30 relative overflow-hidden shadow-lg flex flex-col justify-center min-h-[160px]">
                                                    <div className="relative z-10"><h2 className="text-2xl font-bold mb-2">æ¬¢è¿æ¥åˆ°æƒ é€šæ¡¥æ˜Ÿäº‘</h2><p className="text-slate-300">æ‰€æœ‰å•è¯å·²å‡çº§ä¸º <span className="text-yellow-400 font-bold px-2 py-0.5 bg-yellow-400/10 rounded">ä¸¥è°¨æ‹†è¯æ³•</span>ï¼</p></div>
                                                    <Sparkles className="absolute top-2 right-2 text-yellow-400/20 w-24 h-24 animate-pulse"/>
                                                </div>
                                                <button onClick={() => setActiveTab('creative')} className="bg-gradient-to-br from-pink-900 to-purple-900 rounded-2xl p-6 text-center border border-pink-500/30 relative overflow-hidden shadow-lg group hover:scale-[1.02] transition-transform min-h-[160px] flex flex-col justify-center items-center">
                                                    <div className="relative z-10 flex flex-col items-center"><div className="bg-pink-500/20 p-3 rounded-full mb-3 group-hover:bg-pink-500/40 transition-colors"><PenTool className="w-8 h-8 text-pink-300"/></div><h2 className="text-2xl font-bold mb-1 text-white">ğŸ¨ åˆ›æ„å®éªŒå®¤</h2><p className="text-pink-200/80 text-sm">ç”¨ä½ å­¦è¿‡çš„å•è¯å†™æ•…äº‹ âœ¨</p></div>
                                                    <div className="absolute inset-0 bg-pink-600/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                                </button>
                                            </div>
                                            {WORD_GALAXIES.map((galaxy) => (
                                                <div key={galaxy.id} className="space-y-4">
                                                    <div className="flex items-center gap-2 border-b border-slate-800 pb-2">{galaxy.icon}<h3 className="text-xl font-bold text-slate-200">{galaxy.cnName}</h3></div>
                                                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                                        {galaxy.words.map((word) => {
                                                            const isCompleted = completedWords.includes(word);
                                                            const hasData = !!RICH_LEVELS[word]; 
                                                            return (
                                                                <button key={`word-btn-${word}`} onClick={() => handleStartLevel(word)} disabled={!hasData} className={`p-4 rounded-xl border-2 flex flex-col items-center gap-3 aspect-square justify-center transition-all hover:-translate-y-1 relative group ${isCompleted ? 'bg-slate-800 border-green-500/50 shadow-[0_0_15px_rgba(34,197,94,0.1)]' : 'bg-slate-800 border-slate-700 hover:border-blue-500'} ${!hasData && 'opacity-50'}`}>
                                                                    {isCompleted && <div className="absolute top-2 right-2"><Star className="w-4 h-4 text-green-500" style={{ fill: "currentColor" }}/></div>}
                                                                    <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl shadow-inner transition-colors ${isCompleted ? 'bg-green-900 text-green-300' : 'bg-slate-700 text-slate-300 group-hover:bg-blue-600 group-hover:text-white'}`}>{word[0]}</div>
                                                                    <span className={`text-sm font-medium transition-colors ${isCompleted ? 'text-green-400' : 'text-slate-300 group-hover:text-white'}`}>{word}</span>
                                                                </button>
                                                            )
                                                        })}
                                                    </div>
                                                </div>
                                            ))}
                                        </main>
                                    )}
                                    {activeTab === 'reading' && <ReadingRoom />}
                                    {activeTab === 'creative' && <CreativeLab unlockedWords={completedWords} />}
                                </>
                            )}
                        </div>
                    </div>
                </TooltipProvider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        // å°†æ•´ä¸ªåº”ç”¨åŒ…è£¹åœ¨é”™è¯¯è¾¹ç•Œå†…
        root.render(
            <ErrorBoundary>
                <WordGalaxy />
            </ErrorBoundary>
        );
    </script>
</body>
</html>